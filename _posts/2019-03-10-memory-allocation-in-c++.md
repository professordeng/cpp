# memory allocation in c++

C++ 程序编译后分为五个不同的段分别存放不同类型的数据。

1. BBS 段 `bss segment`

   通常是指用来存放程序中未初始化的全局变量的一块内存区域。BSS 是英文 Block Started by Symbol 的简称。BSS 段属于静态内存分配。

2. 数据段 `data segment`

   通常是指用来存放程序中已初始化的全局变量的一块内存区域。数据段属于静态内存分配。

3. 代码段 `code segment/text segment`

   通常是指用来存放程序执行代码的一块内存区域。这部分区域的大小在程序运行前就已经确定，并且内存区域通常属于只读, 某些架构也允许代码段为可写，即允许修改程序。在代码段中，也有可能包含一些只读的常数变量，例如字符串常量等。

4. 堆 `heap`

   用于存放进程运行中被动态分配的内存段，它的大小并不固定，可动态扩张或缩减。当进程调用malloc等函数分配内存时，新分配的内存就被动态添加到堆上（堆被扩张）；当利用free等函数释放内存时，被释放的内存从堆中被剔除（堆被缩减）

5. 栈 `stack`

   栈又称堆栈， 是用户存放程序临时创建的局部变量，也就是说我们函数括弧 `{}`中定义的变量（但不包括 `static` 声明的变量，`static` 意味着在数据段中存放变量）。除此以外，在函数被调用时，其参数也会被压入发起调用的进程栈中，并且待到调用结束后，函数的返回值也会被存放回栈中。由于栈的先进先出特点，所以栈特别方便用来保存和恢复调用现场。从这个意义上讲，我们可以把堆栈看成一个寄存、交换临时数据的内存区。

那么程序实际运行时，C++ 主要用到下面五块内存区域。

1. 栈区

   由编译器自动分配释放 ，存放函数的参数值，局部变量的值等。其操作方式类似于数据结构中的栈。 

2. 堆区

   一般由程序员分配释放， 若程序员不释放，程序结束时可能由OS回收 。注意它与数据结构中的堆是两回事，分配方式倒是类似于链表。

3. 全局区（静态区）

   全局变量和静态变量的存储是放在一块的，初始化的全局变量和静态变量在一块区域， 未初始化的全局变量和未初始化的静态变量在相邻的另一块区域。 - 程序结束后有系统释放 。

4. 文字常量区

   常量字符串就是放在这里的， 程序结束后由系统释放。常量字符串是双引号里面的字符串，后面编译器会自动补0，由于常量字符串是代码的一部分，不可能很多，因此可以开一个内存区存放来提高效率。

5. 程序代码区

   存放函数体的二进制代码。

## 动态内存和静态内存的区别

1. 静态内存

   静态内存是指在程序开始运行时由编译器分配的内存，它的分配是在程序开始编译时完成的，不占用CPU资源。

   程序中的各种变量，在编译时系统已经为其分配了所需的内存空间，当该变量在作用域内使用完毕时，系统会自动释放所占用的内存空间。

   变量的分配与释放，都无须程序员自行考虑。

2. 动态内存

   用户无法确定空间大小，或者空间太大，栈上无法分配时，会采用动态内存分配。例如 C++ 的 string 类，当字符串长度小于 16 时，会将其数据存放在栈区，大于16之后会将其存放在堆区。

区别如下

- 静态内存分配在编译时完成，不占用CPU资源; 动态内存分配在运行时，分配与释放都占用CPU资源。
- 静态内存在栈(stack)上分配; 动态内存在堆(heap)上分配。
- 动态内存分配需要指针和引用类型支持，静态不需要。
- 静态内存分配是按计划分配，由编译器负责; 动态内存分配是按需分配，由程序员负责。